# Basic PACT Contract Testing Guide

This guide will walk you through the fundamentals of PACT contract testing using our framework.

## 🎯 What is PACT?

PACT is a contract testing framework that ensures API compatibility between services. It follows the consumer-driven contract testing pattern where:

1. **Consumers** define what they expect from providers
2. **Providers** verify they can fulfill these expectations
3. **Contracts** are shared and validated automatically

## 🏗️ Basic Concepts

### Consumer
The service that makes requests to another service (the provider).

### Provider
The service that receives requests and provides responses.

### Contract
A specification that defines the expected interactions between consumer and provider.

### PACT File
A JSON file containing the contract details, generated by consumer tests.

## 🚀 Your First PACT Test

Let's create a simple user service contract test.

### Step 1: Create a Consumer Service

```javascript
// examples/consumer/userService.js
const axios = require('axios');

class UserService {
  constructor(baseURL = 'http://localhost:3001') {
    this.client = axios.create({
      baseURL,
      timeout: 5000,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  async getAllUsers() {
    const response = await this.client.get('/api/users');
    return response.data;
  }
}

module.exports = UserService;
```

### Step 2: Create a PACT Test

```javascript
// examples/consumer/__tests__/userService.pact.test.js
const { Pact } = require('@pact-foundation/pact');
const path = require('path');
const UserService = require('../userService');

describe('User Service PACT', () => {
  let provider;
  let userService;

  beforeAll(() => {
    provider = new Pact({
      consumer: 'UserServiceConsumer',
      provider: 'UserServiceProvider',
      port: 3002,
      log: path.resolve(process.cwd(), 'logs', 'pact.log'),
      dir: path.resolve(process.cwd(), 'pacts'),
      logLevel: 'INFO'
    });

    return provider.setup();
  });

  beforeEach(() => {
    userService = new UserService(provider.mockService.baseUrl);
  });

  afterEach(() => {
    provider.verify();
  });

  afterAll(() => {
    return provider.finalize();
  });

  it('should return a list of users', async () => {
    // Arrange - Define the expected interaction
    await provider
      .given('users exist')
      .uponReceiving('a request for all users')
      .withRequest({
        method: 'GET',
        path: '/api/users'
      })
      .willRespondWith({
        status: 200,
        headers: { 'Content-Type': 'application/json' },
        body: [
          {
            id: 1,
            name: 'John Doe',
            email: 'john@example.com'
          }
        ]
      });

    // Act - Make the actual request
    const users = await userService.getAllUsers();

    // Assert - Verify the response
    expect(users).toBeDefined();
    expect(Array.isArray(users)).toBe(true);
  });
});
```

### Step 3: Create a Provider

```javascript
// examples/provider/server.js
const express = require('express');
const app = express();

app.use(express.json());

// Mock data
let users = [
  { id: 1, name: 'John Doe', email: 'john@example.com' }
];

app.get('/api/users', (req, res) => {
  res.json(users);
});

app.listen(3001, () => {
  console.log('Provider server running on port 3001');
});

module.exports = app;
```

### Step 4: Create Provider Verification

```javascript
// examples/provider/__tests__/userService.verification.test.js
const { Verifier } = require('@pact-foundation/pact');
const path = require('path');
const app = require('../server');

describe('User Service Provider Verification', () => {
  let server;

  beforeAll(() => {
    server = app.listen(3001);
  });

  afterAll(() => {
    server.close();
  });

  it('should verify the user service contracts', async () => {
    const opts = {
      provider: 'UserServiceProvider',
      providerBaseUrl: 'http://localhost:3001',
      pactUrls: [path.resolve(process.cwd(), 'pacts', 'userserviceconsumer-userserviceprovider.json')],
      stateHandlers: {
        'users exist': () => Promise.resolve()
      }
    };

    return new Verifier().verifyProvider(opts);
  });
});
```

## 🧪 Running Your Tests

### 1. Run Consumer Tests
```bash
npm run test:consumer
```

This will:
- Start a mock provider server
- Run your consumer tests
- Generate PACT files in the `pacts/` directory

### 2. Start Provider Server
```bash
npm run start:provider
```

### 3. Run Provider Verification
```bash
npm run test:provider
```

This will:
- Read the PACT files
- Make real requests to your provider
- Verify the provider matches the contract

## 📋 Understanding PACT Files

After running consumer tests, you'll find PACT files in the `pacts/` directory:

```json
{
  "consumer": { "name": "UserServiceConsumer" },
  "provider": { "name": "UserServiceProvider" },
  "interactions": [
    {
      "description": "a request for all users",
      "providerState": "users exist",
      "request": {
        "method": "GET",
        "path": "/api/users"
      },
      "response": {
        "status": 200,
        "headers": { "Content-Type": "application/json" },
        "body": [...]
      }
    }
  ]
}
```

## 🎨 Using Matchers

Instead of exact values, use PACT matchers for flexible matching:

```javascript
const { Matchers } = require('@pact-foundation/pact');
const { like, eachLike } = Matchers;

// Flexible string matching
name: like('John Doe')

// Array of objects
body: eachLike({
  id: like(1),
  name: like('John Doe'),
  email: like('john@example.com')
}, { min: 1 })
```

## 🔄 The PACT Flow

1. **Consumer Test**: Defines expectations and generates PACT file
2. **Provider Verification**: Validates provider against PACT file
3. **Contract Sharing**: PACT files are shared between teams
4. **Continuous Integration**: Automated testing in CI/CD pipeline

## 🚨 Common Pitfalls

### 1. Exact Value Matching
❌ **Don't do this:**
```javascript
body: {
  id: 1,
  createdAt: '2023-01-01T00:00:00Z'
}
```

✅ **Do this:**
```javascript
body: {
  id: like(1),
  createdAt: iso8601DateTime()
}
```

### 2. Missing Provider States
❌ **Don't do this:**
```javascript
await provider
  .uponReceiving('a request for users')
  .withRequest({...})
  .willRespondWith({...});
```

✅ **Do this:**
```javascript
await provider
  .given('users exist')
  .uponReceiving('a request for users')
  .withRequest({...})
  .willRespondWith({...});
```

### 3. Not Verifying Provider
Always run provider verification to ensure your provider actually works!

## 📚 Next Steps

1. **Explore the examples** in the `examples/` directory
2. **Try different matchers** for flexible testing
3. **Add error scenarios** to your contracts
4. **Set up a PACT Broker** for contract sharing
5. **Integrate with CI/CD** for automated testing

## 🆘 Getting Help

- Check the logs in `logs/pact.log`
- Review the generated PACT files
- Consult the [PACT documentation](https://docs.pact.io/)
- Look at the advanced examples in this framework

Happy contract testing! 🎉
